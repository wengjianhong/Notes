> Code过程中的发现一些编码小技巧

### 1.如何设置定时任务？

#### 场景

如何设置一个定时任务，实现每秒钟执行一次？

#### 解决方案

如果只是一些简单的操作，又或者定时任务的时间间隔比较长，比如15分钟，1小时，可以用一些简单实现方式

```cpp
while(flag){
    doSomething();
    Sleep(15 * 60 * 1000) // 睡眠15分钟
}
```

当然，也可以直接借助系统的定时工具，比如crontab。

#### 问题

如果一个任务，要求：

​	1.间隔较短的时间（1秒）执行一次

​	2.doSomething() 比较耗时且执行时间不固定的处理过程

​	3.严格要求在间隔的时间内执行一次任务（定时刷新 / 定时记录数据）

怎么样保证每次能在间隔固定时间执行一次定时任务？

#### 分析

首先：由于间隔时间比较短，所以每次睡眠的时候必须减去doSomething()函数中的占用的时间必须减掉

其次：doSomething() 的执行时间不固定，所以不能简单的减掉固定值

实现：

```cpp
long long GetTimestamp(){
   	// 获取当前的时间戳（毫秒）
    ... ...
   	return timestamp;
}
void solve(){
    int SLEEP_TIME = 1000; // 毫秒
    while(flag){
    	doSomething();
       Sleep(abs(long(SLEEP_TIME - (GetTimestamp() % SLEEP_TIME)))); // 关键实现!!!
   }
}
```

上述的实现代码中，假设当前时间戳是：136689，则休眠时间：1000 - (136689 % 1000) = 311，相当于，每次都是睡眠到1000毫秒的整数倍

#### 扩展

上面的实现中其实还存在一个小问题，即：

​	假设doSomething()函数耗时比较长并且超过了原计划的定时间隔SLEEP_TIME

针对这种情况，如果想要在遇到这类情况立即执行任务，如何改进？

---



#### 2.

